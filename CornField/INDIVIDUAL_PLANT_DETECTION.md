# 单株植物检测功能说明

## 🌱 功能概述

`crop_row_finder.py` 现在不仅能检测作物行，还能在每条作物行的切面上**自动检测单株植物的位置**。

## 🔬 检测方法（Robust方法）

### 核心思路
类似于作物行检测，使用**高度分布分析 + 平滑 + 规律性Peak检测**：

```
切面点云 → 沿行方向binned统计 → 高斯平滑 → Peak检测 → 规律性过滤
```

### 算法流程图

```
切面点云 (Y, Z, weights)
    ↓
沿Y轴分bin (2cm) + 加权平均
    ↓
高度曲线 [0.2, 0.5, 0.8, 0.9, 0.7, 0.4, 0.6, 0.9, 0.8, ...]
    ↓
高斯平滑 (σ=6 bins = 12cm)
    ↓
检测所有peaks (prominence > 5cm)
    peaks: [3, 7, 15, 23, 28, 35, ...]
    heights: [0.9, 0.9, 0.85, 0.82, 0.75, 0.70, ...]
    ↓
构建最大堆（按高度排序）
    heap: [(-0.9, pos_3), (-0.9, pos_7), (-0.85, pos_15), ...]
    ↓
贪心选择（最小间距15cm）
    1️⃣ Pop: height=0.9, pos=0.12m → 选中 ✓
    2️⃣ Pop: height=0.9, pos=0.25m → 距离0.13m < 15cm → 丢弃 ✗
    3️⃣ Pop: height=0.85, pos=0.48m → 距离0.36m ≥ 15cm → 选中 ✓
    4️⃣ Pop: height=0.82, pos=0.67m → 距离0.19m ≥ 15cm → 选中 ✓
    ...
    ↓
输出：[0.12, 0.48, 0.67, 0.89, ...] (植株位置)
```

### 详细步骤

1. **加权高度分布计算**
   - 沿切面方向（Y或X）以1cm粒度分bin
   - 使用高斯权重对每个bin内的高度加权平均
   - 得到沿作物行方向的高度曲线

2. **高斯平滑** (σ=3cm)
   - 去除高频噪声
   - 保留植株主体特征

3. **Peak初步检测**
   - 使用 `scipy.signal.find_peaks`
   - prominence > 5cm（植株高度显著性）
   - 检测所有候选peaks

4. **基于堆的最小间距过滤** ⭐ **NEW**
   - 使用**最大堆**（按高度优先）
   - **贪心算法**：
     1. 从堆中弹出当前最高的peak
     2. 检查与已选择peaks的间距
     3. 如果所有间距 ≥ 15cm，接受该peak
     4. 否则，丢弃该peak
     5. 重复直到堆为空
   - **优势**：
     - 优先保留高度更高的植株（更可靠）
     - 严格保证最小间距（避免过密检测）
     - 不依赖规律性假设（适应不规则种植）

## 📊 可视化输出

### 切面图增强（双面板布局）

#### 上图：点云切面 + 标记
- 高斯加权点云（点大小和透明度反映权重）
- **红色虚线**：垂直于行方向的植物位置
- **红色叉叉 (X)**：准确标记植物的(Y/X, Height)坐标

#### 下图：高度曲线
- 蓝色实线：平滑后的高度分布曲线
- **红色叉叉 (X)**：检测到的植物peak位置
- 红色虚线：与上图对齐的位置参考线

### 示例效果
```
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
  点云切面（彩色高度渲染）
         X      X      X      X      X
      ┊   ┊   ┊   ┊   ┊   ┊   ┊   ┊
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
  高度曲线（蓝色波形）
       ╱╲    ╱╲    ╱╲    ╱╲    ╱╲
      X  ┊  X  ┊  X  ┊  X  ┊  X  ┊
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
```

## 📁 输出文件

### 1. 切面PNG图像
```
visualization/
└── tile_i_j/
    └── cross_sections/
        ├── x_row_001_at_10.25m.png  ← 带植物标记的切面
        ├── x_row_002_at_10.75m.png
        ├── y_row_001_at_5.50m.png
        └── ...
```

### 2. 植物位置CSV
```
visualization/
└── tile_i_j/
    └── individual_plants.csv
```

**CSV格式**：
```csv
tile_id,row_type,row_id,row_pos,plant_id,plant_coord,plant_x,plant_y
0_0,X,1,10.25,1,5.12,10.25,5.12
0_0,X,1,10.25,2,5.62,10.25,5.62
0_0,X,1,10.25,3,6.10,10.25,6.10
0_0,Y,1,5.50,1,10.05,10.05,5.50
...
```

字段说明：
- `tile_id`: Tile编号
- `row_type`: X轴行或Y轴行
- `row_id`: 该类型中的行编号
- `row_pos`: 作物行的位置（X或Y坐标）
- `plant_id`: 该行内的植株编号
- `plant_coord`: 植株在行方向的坐标
- `plant_x`, `plant_y`: 植株的绝对XY坐标

### 3. 汇总统计
```
visualization/
└── summary.txt
```

新增统计信息：
```
Total individual plants detected: 1234
...
Tile (0,0): ... plants=156
Tile (0,1): ... plants=142
```

## 🎯 为什么这个方法Robust？

### 1. **高斯加权而非硬截断**
- 点对高度的贡献随距离平滑衰减
- 避免边界效应
- 更能代表植株实际位置

### 2. **基于堆的优先级选择** ⭐ **NEW**
- **高度优先**：优先保留更高的植株（更可能是真实植株）
- **硬间距约束**：严格保证15cm最小间距，避免过密
- **贪心最优**：在满足间距约束下，选择尽可能多的高峰
- **不依赖规律性**：适应不规则种植模式

### 3. **多尺度平滑**
- Binned统计（2cm）：初步聚合
- 高斯平滑（12cm，sigma=6）：去噪保形
- 适应不同作物大小

### 4. **与作物行检测一致的方法论**
- 同样的binned_statistic加速
- 同样的高度profile + 平滑 + peak检测流程
- 已被证明有效的成熟方法

## 🚀 使用方法

```bash
python crop_row_finder.py soybean.las --downsample 0.02 --tile_size 20
```

自动输出：
- ✅ 作物行检测结果
- ✅ CHM可视化
- ✅ **切面视图（带单株植物标记）**
- ✅ **individual_plants.csv**

## 📈 性能特点

- **速度**：已优化（二分查找 + 智能降采样）
- **精度**：1cm粒度 + 高斯加权
- **鲁棒性**：CV自适应 + prominence过滤
- **可扩展**：易于调整参数（prominence, distance, CV阈值）

## ⚙️ 关键参数

### 在 `detect_individual_plants_in_section()` 中：

```python
granularity = 0.02           # 2cm bin大小
sigma = 6                    # 高斯平滑sigma（12cm，6*2cm）
prominence = 0.05            # Peak显著性（5cm）
min_spacing = 0.15           # 最小植株间距（15cm）⭐
```

### 可调优方向：
- **增大 `min_spacing`** → 适应稀疏种植（如玉米：20-30cm）
- **减小 `min_spacing`** → 适应密集种植（如小麦：5-10cm）
- **增大 `prominence`** → 只检测高大植株，减少误检
- **调整 `sigma`** → 更大的平滑去除更多细节噪声

---

🎉 **现在可以直接从点云数据获得单株植物的精确位置！**
